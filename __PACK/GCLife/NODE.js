GCLife.ArticleModel=OBJECT({preset:function(){"use strict";return GCLife.MODEL},params:function(){"use strict";var e={writerId:{notEmpty:!0,id:!0},title:{notEmpty:!0,size:{max:255}},content:{notEmpty:!0,size:{max:3e3}},viewCount:{notEmpty:!0,integer:!0},lastViewTime:{date:!0},commentCount:{notEmpty:!0,integer:!0},lastCommentTime:{date:!0}};return{name:"Article",initData:{viewCount:0,commentCount:0},methodConfig:{create:{valid:VALID(e),authKey:"writerId",role:GCLife.ROLE.USER},update:{valid:VALID(e),authKey:"writerId",role:GCLife.ROLE.USER},remove:{authKey:"writerId",role:GCLife.ROLE.USER}}}}}),GCLife.BoardModel=OBJECT({preset:function(){"use strict";return GCLife.MODEL},params:function(){"use strict";var e={name:{notEmpty:!0,size:{max:255}},description:{size:{max:3e3}},index:{real:!0},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Board",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:GCLife.ROLE.MANAGER},update:{valid:VALID(e),role:GCLife.ROLE.MANAGER},remove:{role:GCLife.ROLE.MANAGER}}}}}),GCLife.CategoryModel=OBJECT({preset:function(){"use strict";return GCLife.MODEL},params:function(){"use strict";var e={boardId:{notEmpty:!0,id:!0},category:{notEmpty:!0,size:{max:255}},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Category",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:GCLife.ROLE.MANAGER},update:{valid:VALID(e),role:GCLife.ROLE.MANAGER},remove:{role:GCLife.ROLE.MANAGER}}}}}),GCLife.CommentModel=OBJECT({preset:function(){"use strict";return GCLife.MODEL},params:function(){"use strict";var e={writerId:{notEmpty:!0,id:!0},articleId:{notEmpty:!0,id:!0},content:{notEmpty:!0,size:{max:1e3}}};return{name:"Comment",methodConfig:{create:{valid:VALID(e),authKey:"writerId",role:GCLife.ROLE.USER},update:{valid:VALID(e),authKey:"writerId",role:GCLife.ROLE.USER},remove:{authKey:"writerId",role:GCLife.ROLE.USER}}}}}),GCLife.JoinKeyModel=OBJECT({preset:function(){"use strict";return GCLife.MODEL},params:function(){"use strict";return{name:"JoinKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),GCLife.SessionKeyModel=OBJECT({preset:function(){"use strict";return GCLife.MODEL},params:function(){"use strict";return{name:"SessionKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),GCLife.UserModel=OBJECT({preset:function(){"use strict";return GCLife.MODEL},params:function(){"use strict";var e={username:{notEmpty:!0,size:{min:4,max:20},username:!0},nickname:{notEmpty:!0,size:{min:2,max:20}},email:{notEmpty:!0,size:{min:5,max:320},email:!0},password:{notEmpty:!0,size:{min:4,max:20}},loginCount:{notEmpty:!0,integer:!0},lastLoginTime:{date:!0},isBanned:{bool:!0},isLeft:{bool:!0},isAgreedTerms:{notEmpty:!0,equal:!0},isAgreedPrivacy:{notEmpty:!0,equal:!0},roles:{array:!0}};return{name:"User",initData:{loginCount:0},methodConfig:{create:{valid:VALID(e)},update:{valid:VALID(e),authKey:"id",role:GCLife.ROLE.USER},remove:!1},loginValid:VALID({username:e.username,password:e.password})}}}),GCLife("ROLE").ADMIN="Admin",GCLife("ROLE").MANAGER="Manager",GCLife("ROLE").USER="User";function __responseError(_,e,t,r,s,a){a({statusCode:500,content:'<!doctype html><html><head><meta charset="UTF-8"><title>'+e+"</title></head><body><p><b>"+e+"</b></p><b>path: </b>"+_+" ("+r+":"+s+")"+(void 0===t?"":"<br><b>code: </b>"+t)+"</body></html>",contentType:"text/html"})}function __responseNotFound(_){_({statusCode:404,content:'<!doctype html><html><head><meta charset="UTF-8"><title>Page not found.</title></head><body><p><b>Page not found.</b></p></body></html>',contentType:"text/html"})}GCLife.MAIN=METHOD({run:function(_){"use strict";var e=NSP({rootPath:"./GCLife/view",restURI:["account/create","board"]});_(e.requestListener),UMAIL.CONNECT_TO_MAIL_SERVER({host:"smtp.gmail.com",port:465,isSecure:!0,username:NODE_CONFIG.GCLife.email,password:NODE_CONFIG.GCLife.emailPassword},function(_){GCLife.sendMail=_})}});var __path=require("path"),__sharedStore=SHARED_STORE("__NSP_SHARED_STORE"),__parseFuncStr=function __parse(__requestInfo,__sourcePath,__source,__response,self,__isNotUsingDCBN){function print(_){void 0!==_&&(__html+="string"==typeof _?_:JSON.stringify(_))}function save(_,e){void 0===e?__sharedStore.remove(_):__sharedStore.save({name:_,value:e})}function load(_){return __sharedStore.get(_)}function cookie(_,e,t,r,s){return void 0===e?(e=__cookieInfo[_],CHECK_IS_DATA(e)===!0?e.value:e):(__newCookieInfo[_]=__cookieInfo[_]={value:e,expireSeconds:t,path:r,domain:s},e)}function upload(_,e){var t,r,s;CHECK_IS_DATA(e)!==!0?t=e:(t=e.success,r=e.error,s=e.overFileSize),UPLOAD_REQUEST({requestInfo:__requestInfo,uploadPath:__path.dirname(__sourcePath)+"/"+_},{error:r,overFileSize:s,success:t})}function redirect(_){__redirectURL=_}function pause(){0>=toPauseCount?__isPaused=!0:toPauseCount-=1}var __html="",__redirectURL,__lastIndex=0,__startCodeIndex=-1,__startPstrIndex=-1,__startPstr2Index=-1,__startCondIndex=-1,__startEachIndex=-1,toPauseCount=0,__isPaused=!0,__lastCond,__lastCondStack=[],__isIgnored,__isIgnoreStack=[],__isRepeatStack=[],__repeatInfo,__repeatSplits,__repeatTarget,__repeatTargetName,__repeatTargetNowKey,__repeatTargetBeforeKey,__repeatTargetFirstKey,__repeatItemStr,__repeatItemSplits,__repeatItemName,__repeatItemValue,__cookieInfo=__requestInfo.cookies,__newCookieInfo={},__i,__ch,__line=1,__column=1,__lastLine=1,__lastColumn=1;eval(__resumeFuncStr),resume()}.toString(),__resumeFuncStr=function resume(){function include(__uri,__callback){var __fullPath=__path.dirname(__sourcePath)+"/"+__uri,savedLastIndex=__lastIndex;pause(),READ_FILE(__fullPath,{notExists:function(){__responseError(__fullPath,"File not exists.",__source.substring(savedLastIndex,__i-1),__lastLine,__lastColumn,__response)},success:function(__buffer){var ext=__path.extname(__uri).toLowerCase();if(".nsp"===ext)__parse(__requestInfo,__fullPath,__buffer.toString(),function(_){print(_.content),void 0!==__callback&&__callback(),resume()},self,__isNotUsingDCBN);else if(".js"===ext){try{eval(__buffer.toString())}catch(e){return void __responseError(__fullPath,e,__buffer.toString(),1,1,__response)}void 0!==__callback&&__callback(),resume()}else print(__buffer.toString()),resume()}})}if(__isPaused!==!0)toPauseCount+=1;else{for(__isPaused=!1,eval(__parseFuncStr),eval(__resumeFuncStr),__i=__lastIndex;__i<=__source.length;__i+=1){if(__ch=__source[__i],__i>0)if("%"===__ch&&"<"===__source[__i-1])__isIgnored===!0||void 0!==__repeatInfo&&void 0===__repeatInfo.key||-1!==__startCodeIndex||-1!==__startPstrIndex||-1!==__startPstr2Index||-1!==__startCondIndex||-1!==__startEachIndex||("="===__source[__i+1]?(__i>2&&"\\"===__source[__i-3]&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),__startPstr2Index=__i+2):__i>1&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),print(__source.substring(__i-1,__i+2))):(print(__source.substring(__lastIndex,__i-1)),__startPstr2Index=__i+2),__lastIndex=__i+2,__lastLine=__line,__lastColumn=__column-1):(__i>2&&"\\"===__source[__i-3]&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),__startCodeIndex=__i+1):__i>1&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),print(__source.substring(__i-1,__i+1))):(print(__source.substring(__lastIndex,__i-1)),__startCodeIndex=__i+1),__lastIndex=__i+1,__lastLine=__line,__lastColumn=__column-1));else if(">"===__ch&&"%"===__source[__i-1]){if(__isIgnored!==!0&&(void 0===__repeatInfo||void 0!==__repeatInfo.key)&&-1===__startPstrIndex&&-1===__startCondIndex&&-1===__startEachIndex)if(-1!==__startCodeIndex&&-1===__startPstr2Index){try{eval(__source.substring(__lastIndex,__i-1))}catch(e){return void __responseError(__sourcePath,e,__source.substring(__lastIndex,__i-1),__lastLine,__lastColumn,__response)}if(__startCodeIndex=-1,__lastIndex=__i+1,__isPaused===!0)return void(__column+=1)}else if(-1===__startCodeIndex&&-1!==__startPstr2Index){try{print(eval(__source.substring(__lastIndex,__i-1)))}catch(e){return void __responseError(__sourcePath,e,__source.substring(__lastIndex,__i-1),__lastLine,__lastColumn,__response)}if(__startPstr2Index=-1,__lastIndex=__i+1,__isPaused===!0)return void(__column+=1)}}else if(__isNotUsingDCBN!==!0&&"{"===__ch&&"{"===__source[__i-1])__isIgnored===!0||void 0!==__repeatInfo&&void 0===__repeatInfo.key||-1!==__startCodeIndex||-1!==__startPstrIndex||-1!==__startPstr2Index||-1!==__startCondIndex||-1!==__startEachIndex||(__i>2&&"\\"===__source[__i-3]&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),__startPstrIndex=__i+1):__i>1&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),print(__source.substring(__i-1,__i+1))):(print(__source.substring(__lastIndex,__i-1)),__startPstrIndex=__i+1),__lastIndex=__i+1,__lastLine=__line,__lastColumn=__column-1);else if("}"===__ch&&"}"===__source[__i-1]){if(__isIgnored!==!0&&(void 0===__repeatInfo||void 0!==__repeatInfo.key)&&-1===__startCodeIndex&&-1!==__startPstrIndex&&-1===__startPstr2Index&&-1===__startCondIndex&&-1===__startEachIndex){try{print(eval(__source.substring(__lastIndex,__i-1)))}catch(e){return void __responseError(__sourcePath,e,__source.substring(__lastIndex,__i-1),__lastLine,__lastColumn,__response)}if(__startPstrIndex=-1,__lastIndex=__i+1,__isPaused===!0)return void(__column+=1)}}else if("?"===__ch&&"<"===__source[__i-1])void 0!==__repeatInfo&&void 0===__repeatInfo.key||-1!==__startCodeIndex||-1!==__startPstrIndex||-1!==__startPstr2Index||-1!==__startCondIndex||-1!==__startEachIndex||(__isIgnored!==!0?(__i>2&&"\\"===__source[__i-3]&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),__startCondIndex=__i+1):__i>1&&"\\"===__source[__i-2]?(print(__source.substring(__lastIndex,__i-2)),print(__source.substring(__i-1,__i+1))):(print(__source.substring(__lastIndex,__i-1)),__startCondIndex=__i+1),__lastIndex=__i+1,__lastLine=__line,__lastColumn=__column-1):__isIgnoreStack.push(!0));else if(__i>3&&">"===__ch&&"?"===__source[__i-1]&&"/"===__source[__i-2]&&"<"===__source[__i-3])void 0!==__repeatInfo&&void 0===__repeatInfo.key||-1!==__startCodeIndex||-1!==__startPstrIndex||-1!==__startPstr2Index||-1!==__startCondIndex||-1!==__startEachIndex||(__i>5&&"\\"===__source[__i-5]&&"\\"===__source[__i-4]?(__isIgnored!==!0&&print(__source.substring(__lastIndex,__i-4)),__isIgnoreStack.pop(),__isIgnored=__isIgnoreStack[__isIgnoreStack.length-1],__isIgnored!==!0&&(__lastCond=__lastCondStack.pop())):__i>3&&"\\"===__source[__i-4]?(print(__source.substring(__lastIndex,__i-4)),print(__source.substring(__i-3,__i+1))):(__isIgnored!==!0&&print(__source.substring(__lastIndex,__i-3)),__isIgnoreStack.pop(),__isIgnored=__isIgnoreStack[__isIgnoreStack.length-1],__isIgnored!==!0&&(__lastCond=__lastCondStack.pop())),__lastIndex=__i+1);else if("~"===__ch&&"<"===__source[__i-1])__isIgnored!==!0&&-1===__startCodeIndex&&-1===__startPstrIndex&&-1===__startPstr2Index&&-1===__startCondIndex&&-1===__startEachIndex&&(__i>2&&"\\"===__source[__i-3]&&"\\"===__source[__i-2]?((void 0===__repeatInfo||void 0!==__repeatInfo.key)&&print(__source.substring(__lastIndex,__i-2)),__startEachIndex=__i+1):__i>1&&"\\"===__source[__i-2]?(void 0===__repeatInfo||void 0!==__repeatInfo.key)&&(print(__source.substring(__lastIndex,__i-2)),print(__source.substring(__i-1,__i+1))):((void 0===__repeatInfo||void 0!==__repeatInfo.key)&&print(__source.substring(__lastIndex,__i-1)),__startEachIndex=__i+1),__lastIndex=__i+1,__lastLine=__line,__lastColumn=__column-1);else if(__i>3&&">"===__ch&&"~"===__source[__i-1]&&"/"===__source[__i-2]&&"<"===__source[__i-3]){if(__isIgnored!==!0&&-1===__startCodeIndex&&-1===__startPstrIndex&&-1===__startPstr2Index&&-1===__startCondIndex&&-1===__startEachIndex){if(__i>5&&"\\"===__source[__i-5]&&"\\"===__source[__i-4])if(void 0!==__repeatInfo&&void 0!==__repeatInfo.key){__repeatTarget=__repeatInfo.target,__repeatTargetName=__repeatInfo.targetName,__repeatTargetFirstKey=__repeatInfo.key,__repeatItemName=__repeatInfo.name,__repeatItemValue=__repeatInfo.value,print(__source.substring(__lastIndex,__i-4)),__repeatTargetBeforeKey=void 0;for(__repeatTargetNowKey in __repeatTarget)if(__repeatTarget.hasOwnProperty(__repeatTargetNowKey)===!0){if(__repeatTargetBeforeKey===__repeatTargetFirstKey){__repeatInfo.key=__repeatTargetNowKey;break}__repeatTargetBeforeKey=__repeatTargetNowKey}void 0!==__repeatTargetFirstKey&&__repeatTargetNowKey!==__repeatTargetFirstKey?(__i=__repeatInfo.startIndex-1,__line=__repeatInfo.line,__column=__repeatInfo.column,void 0===__repeatItemName?eval("var "+__repeatItemValue+" = "+__repeatTargetName+"['"+__repeatTargetNowKey+"'];"):eval("var "+__repeatItemName+" = '"+__repeatTargetNowKey+"';var "+__repeatItemValue+" = "+__repeatTargetName+"['"+__repeatTargetNowKey+"'];")):(__isRepeatStack.pop(),__repeatInfo=__isRepeatStack[__isRepeatStack.length-1])}else __isRepeatStack.pop(),__repeatInfo=__isRepeatStack[__isRepeatStack.length-1];else if(__i>3&&"\\"===__source[__i-4])print(__source.substring(__lastIndex,__i-4)),print(__source.substring(__i-3,__i+1));else if(void 0!==__repeatInfo&&void 0!==__repeatInfo.key){__repeatTarget=__repeatInfo.target,__repeatTargetName=__repeatInfo.targetName,__repeatTargetFirstKey=__repeatInfo.key,__repeatItemName=__repeatInfo.name,__repeatItemValue=__repeatInfo.value,print(__source.substring(__lastIndex,__i-3)),__repeatTargetBeforeKey=void 0;for(__repeatTargetNowKey in __repeatTarget)if(__repeatTarget.hasOwnProperty(__repeatTargetNowKey)===!0){if(__repeatTargetBeforeKey===__repeatTargetFirstKey){__repeatInfo.key=__repeatTargetNowKey;break}__repeatTargetBeforeKey=__repeatTargetNowKey}__repeatTargetNowKey!==__repeatTargetFirstKey?(__i=__repeatInfo.startIndex-1,__line=__repeatInfo.line,__column=__repeatInfo.column,void 0===__repeatItemName?eval("var "+__repeatItemValue+" = "+__repeatTargetName+"['"+__repeatTargetNowKey+"'];"):eval("var "+__repeatItemName+" = '"+__repeatTargetNowKey+"';var "+__repeatItemValue+" = "+__repeatTargetName+"['"+__repeatTargetNowKey+"'];")):(__isRepeatStack.pop(),__repeatInfo=__isRepeatStack[__isRepeatStack.length-1])}else __isRepeatStack.pop(),__repeatInfo=__isRepeatStack[__isRepeatStack.length-1];__lastIndex=__i+1}}else if(">"===__ch&&__isIgnored!==!0&&-1===__startCodeIndex&&-1===__startPstrIndex&&-1===__startPstr2Index)if(void 0!==__repeatInfo&&void 0===__repeatInfo.key||-1===__startCondIndex||-1!==__startEachIndex){if(-1===__startCondIndex&&-1!==__startEachIndex&&"-"!==__source[__i-1]){try{if(__repeatSplits=__source.substring(__lastIndex,__i).split("->"),void 0===__repeatInfo||void 0!==__repeatInfo.key?(__repeatTargetName=__repeatSplits[0],__repeatTarget=eval(__repeatTargetName)):(__repeatTargetName=void 0,__repeatTarget=void 0),__repeatItemStr=__repeatSplits[1],void 0===__repeatTarget)__isRepeatStack.push(__repeatInfo={targetName:__repeatTargetName,value:__repeatItemStr,startIndex:__i+1,line:__line,column:__column});else if(-1===__repeatItemStr.indexOf(":")){__repeatTargetFirstKey=void 0;for(__repeatTargetFirstKey in __repeatTarget)if(__repeatTarget.hasOwnProperty(__repeatTargetFirstKey)===!0)break;__isRepeatStack.push(__repeatInfo={target:__repeatTarget,targetName:__repeatTargetName,key:__repeatTargetFirstKey,value:__repeatItemStr,startIndex:__i+1,line:__line,column:__column}),eval("var "+__repeatItemStr+" = "+__repeatTargetName+"['"+__repeatTargetFirstKey+"'];")}else{__repeatItemSplits=__repeatItemStr.split(":"),__repeatItemName=__repeatItemSplits[0],__repeatItemValue=__repeatItemSplits[1],__repeatTargetFirstKey=void 0;for(__repeatTargetFirstKey in __repeatTarget)if(__repeatTarget.hasOwnProperty(__repeatTargetFirstKey)===!0)break;__isRepeatStack.push(__repeatInfo={target:__repeatTarget,targetName:__repeatTargetName,key:__repeatTargetFirstKey,name:__repeatItemName,value:__repeatItemValue,startIndex:__i+1,line:__line,column:__column}),eval("var "+__repeatItemName+" = '"+__repeatTargetFirstKey+"';var "+__repeatItemValue+" = "+__repeatTargetName+"['"+__repeatTargetFirstKey+"'];")}}catch(e){return void __responseError(__sourcePath,e,__source.substring(__lastIndex,__i),__lastLine,__lastColumn,__response)}if(__startEachIndex=-1,__lastIndex=__i+1,__isPaused===!0)return void(__column+=1)}}else{try{"else"===__source.substring(__lastIndex,__i).trim()?(__lastCond===!0?(__isIgnored=!0,__isIgnoreStack.push(!0)):__isIgnoreStack.push(!1),__lastCondStack.push(!0)):eval(__source.substring(__lastIndex,__i))===!1?(__isIgnored=!0,__isIgnoreStack.push(!0),__lastCondStack.push(!1)):(__isIgnoreStack.push(!1),__lastCondStack.push(!0))}catch(e){return void __responseError(__sourcePath,e,__source.substring(__lastIndex,__i),__lastLine,__lastColumn,__response)}if(__startCondIndex=-1,__lastIndex=__i+1,__isPaused===!0)return void(__column+=1)}"\n"===__ch?(__line+=1,__column=1):__column+=1}-1!==__startCodeIndex||-1!==__startPstrIndex?print(__source.substring(__lastIndex-2)):print(__source.substring(__lastIndex)),void 0!==__redirectURL?__response({statusCode:302,headers:{"Set-Cookie":CREATE_COOKIE_STR_ARRAY(__newCookieInfo),Location:__redirectURL}}):__response({headers:{"Set-Cookie":CREATE_COOKIE_STR_ARRAY(__newCookieInfo)},content:__html,contentType:"text/html"})}}.toString();global.NSP=function(config){var rootPath=config.rootPath,restURI=config.restURI,isNotUsingDCBN=config.isNotUsingDCBN,cachedFileInfos={};return eval(__parseFuncStr),{notExistsResource:function(_,e,t){__responseNotFound(t)},requestListener:function(_,e,t,r,s){var a,n,i=_.uri,o="",d=function(){GET_FILE_INFO(a,{notExists:function(){__responseNotFound(e)},success:function(t){var r=cachedFileInfos[a],s={headers:_.headers,method:_.method,params:_.params,ip:_.ip,subURI:o};void 0!==r&&(void 0!==t.lastUpdateTime&&r.lastUpdateTime.getTime()===t.lastUpdateTime.getTime()||void 0!==t.createTime&&r.lastUpdateTime.getTime()===t.createTime.getTime())?__parse(_,a,r.content,e,s,isNotUsingDCBN):READ_FILE(a,{notExists:function(){__responseNotFound(e)},error:function(_){__responseError(a,_,void 0,1,1,e)},success:function(r){var n=r.toString();cachedFileInfos[a]={content:n,lastUpdateTime:void 0===t.lastUpdateTime?t.createTime:t.lastUpdateTime},__parse(_,a,n,e,s,isNotUsingDCBN)}})}})};return void 0!==restURI&&(CHECK_IS_ARRAY(restURI)===!0?CHECK_IS_IN({array:restURI,value:i})===!0?i=restURI+".nsp":EACH(restURI,function(_){return _+"/"===i.substring(0,_.length+1)?(o=i.substring(_.length+1),i=_+".nsp",!1):void 0}):restURI===i?i=restURI+".nsp":restURI+"/"===i.substring(0,restURI.length+1)&&(o=i.substring(restURI.length+1),i=restURI+".nsp")),""===i&&(i="index.nsp"),a=rootPath+"/"+i,n=__path.extname(i).toLowerCase(),".nsp"===n?(d(),!1):""===n?(CHECK_IS_EXISTS_FILE(a+".nsp",function(_){_===!0?(a+=".nsp",d()):CHECK_IS_EXISTS_FILE(a,function(_){_===!0?CHECK_IS_FOLDER(a,function(_){_===!0?(a+="/index.nsp",d()):s()}):s()})}),!1):void 0}}},OVERRIDE(GCLife.BoardModel,function(_){"use strict";GCLife.BoardModel=OBJECT({preset:function(){return _},init:function(_,e,t){var r,s;_.on("create",{before:function(_,t){return e.get({sort:{index:-1}},{notExists:function(){_.index=0,t()},success:function(e){_.index=e.index+1,t()}}),!1}}),_.on("update",{before:function(_,e,t,r){void 0!==r&&delete _.index}}),e.moveUp=r=function(_,t){e.get(_,function(_){e.get({filter:{index:{$lt:_.index}},sort:{index:-1}},{notExists:t,success:function(r){var s=r.index;e.updateNoHistory({id:r.id,index:_.index}),e.updateNoHistory({id:_.id,index:s}),t()}})})},e.moveDown=s=function(_,t){e.get(_,function(_){e.get({filter:{index:{$gt:_.index}},sort:{index:1}},{notExists:t,success:function(r){var s=r.index;e.updateNoHistory({id:r.id,index:_.index}),e.updateNoHistory({id:_.id,index:s}),t()}})})}}})}),OVERRIDE(GCLife.UserModel,function(_){"use strict";GCLife.UserModel=OBJECT({preset:function(){return _},init:function(_,e,t){var r;_.on("create",{before:function(_,t,r){return e.checkIsExists({filter:{username:_.username}},function(s){s===!0?r({validErrors:{username:{type:"existed"}}}):e.checkIsExists({filter:{nickname:_.nickname}},function(e){e===!0?r({validErrors:{nickname:{type:"existed"}}}):(_.password=SHA256({key:_.username,password:_.password}),delete _.isBanned,delete _.isLeft,_.roles=[GCLife.ROLE.USER],t())})}),!1},after:function(_){delete _.password,GCLife.JoinKeyModel.find({filter:{email:_.email},isFindAll:!0},EACH(function(_){GCLife.JoinKeyModel.remove(_.id)}))}}),e.login=r=function(_,t){e.get({filter:{username:_.username,password:SHA256({key:_.username,password:_.password})}},{notExists:function(){t.notValid()},success:function(_){_.isLeft===!0?t.notValid():GCLife.SessionKeyModel.create({userId:_.id},function(r){e.updateNoHistory({id:_.id,lastLoginTime:new Date,$inc:{loginCount:1}},function(_){t.success(_,r.id)})})}})}}})});