Life.ReplaceUserTagToLink=METHOD({run:function(e,t){var i,n,r=0;(n=function(){for(i=void 0;r<e.length+1;r+=1){if(void 0!==i&&(r===e.length||"@"===e[r]||" "===e[r]||"	"===e[r]||"\n"===e[r]||"\r"===e[r]||"<"===e[r]))return void Life.UserModel.get({filter:{nickname:e.substring(i,r)}},{notExists:function(){n()},success:function(t){var o='<a href="/user/'+t.id+'">'+t.nickname+"</a>";e=e.substring(0,i-1)+o+(r<e.length?e.substring(r):""),r+=o.length-(r-i)-1,n()}});r<e.length&&"@"===e[r]&&(i=r+1)}t(e)})()}}),Life.ArticleLikeModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={articleId:{notEmpty:!0,id:!0},userId:{notEmpty:!0,id:!0}};return{name:"ArticleLike",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.ArticleModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={boardId:{notEmpty:!0,id:!0},categoryId:{id:!0},writerId:{notEmpty:!0,id:!0},title:{notEmpty:!0,size:{max:255}},content:{size:{max:3e4}},html:!0,viewCount:{notEmpty:!0,integer:!0},lastViewTime:{date:!0},commentCount:{notEmpty:!0,integer:!0},lastCommentTime:{date:!0},likeCount:{notEmpty:!0,integer:!0}};return{name:"Article",initData:{viewCount:0,commentCount:0,likeCount:0},methodConfig:{create:{valid:VALID(e),authKey:"writerId",role:Life.ROLE.USER},update:{valid:VALID(e),authKey:"writerId",role:Life.ROLE.USER},remove:{authKey:"writerId",role:Life.ROLE.USER}}}}}),Life.BoardModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={name:{notEmpty:!0,size:{max:255}},description:{size:{max:3e3}},html:!0,index:{real:!0},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Board",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:Life.ROLE.MANAGER},update:{valid:VALID(e),role:Life.ROLE.MANAGER},remove:{role:Life.ROLE.MANAGER}}}}}),Life.CategoryModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={boardId:{notEmpty:!0,id:!0},category:{notEmpty:!0,size:{max:255}},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Category",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:Life.ROLE.MANAGER},update:{valid:VALID(e),role:Life.ROLE.MANAGER},remove:{role:Life.ROLE.MANAGER}}}}}),Life.CommentLikeModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={commentId:{notEmpty:!0,id:!0},userId:{notEmpty:!0,id:!0}};return{name:"CommentLike",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.CommentModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={writerId:{notEmpty:!0,id:!0},articleId:{notEmpty:!0,id:!0},content:{notEmpty:!0,size:{max:1e3}},likeCount:{notEmpty:!0,integer:!0}};return{name:"Comment",initData:{likeCount:0},methodConfig:{create:{valid:VALID(e)},update:{valid:VALID(e)}}}}}),Life.JoinKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"JoinKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.SessionKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"SessionKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.UserModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={username:{notEmpty:!0,size:{min:4,max:20},username:!0},nickname:{notEmpty:!0,size:{min:2,max:20}},email:{notEmpty:!0,size:{min:5,max:320},email:!0},password:{notEmpty:!0,size:{min:4,max:20}},loginCount:{notEmpty:!0,integer:!0},lastLoginTime:{date:!0},isBanned:{bool:!0},isLeft:{bool:!0},isAgreedTerms:{notEmpty:!0,equal:!0},isAgreedPrivacy:{notEmpty:!0,equal:!0},roles:{array:!0},iconFileId:{id:!0},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0},lastCommentTime:{date:!0},commentCount:{notEmpty:!0,integer:!0},intoduce:{size:{max:3e4}},html:!0};return{name:"User",initData:{loginCount:0,articleCount:0,commentCount:0},methodConfig:{create:{valid:VALID(e)},update:{valid:VALID(e)},remove:!1},loginValid:VALID({username:e.username,password:e.password})}}}),Life("ROLE").ADMIN="Admin",Life("ROLE").MANAGER="Manager",Life("ROLE").USER="User";global.LOAD_NSP=METHOD(function(e){var t={};return{run:function(e,n){var i=e.requestInfo,o=e.path,r=e.self,s=e.isNotUsingDCBN,d=n.notExists,a=n.error,u=n.success;GET_FILE_INFO(o,{notExists:d,success:function(e){var n=t[o];void 0!==n&&(void 0!==e.lastUpdateTime&&n.lastUpdateTime.getTime()===e.lastUpdateTime.getTime()||void 0!==e.createTime&&n.lastUpdateTime.getTime()===e.createTime.getTime())?n.run(i,r,a,u):READ_FILE(o,{notExists:d,error:a,success:function(n){var d=new Function("__requestInfo","self","__errorHandler","__handler",NSP({path:o,code:n.toString(),isNotUsingDCBN:s}));t[o]={lastUpdateTime:void 0===e.lastUpdateTime?e.createTime:e.lastUpdateTime,run:d},d(i,r,a,u)}})}})}}}),Life.MAIN=METHOD({run:function(e){"use strict";var t=require("less");e(NSP_BRIDGE({rootPath:"./Life/view",restURI:["account/create","board","article","user"]}).requestListener),RESOURCE_SERVER.addPreprocessor({extension:"less",preprocessor:function(e,n){t.render(e,function(e,t){n({content:t.css,contentType:"text/css",version:CONFIG.version})})}}),UMAIL.CONNECT_TO_MAIL_SERVER({host:"smtp.gmail.com",port:465,isSecure:!0,username:NODE_CONFIG.Life.email,password:NODE_CONFIG.Life.emailPassword},function(e){Life.sendMail=e})}}),global.NSP=METHOD(function(e){var t,n,i,o=require("path"),r={},s=SHARED_STORE("__NSP_SHARED_STORE");return e.getSavedCodes=t=function(){return r},e.getSharedStore=n=function(){return s},e.generateErrorDisplay=i=function(e){var t="";return t+="<p><b>"+e.error+"</b></p>",t+="<p><b>path: </b>"+e.path+" ("+e.startLine+":"+e.startColumn+"~"+e.endLine+":"+e.endColumn+")</p>",t+="<pre>"+r[e.path].substring(e.startIndex,e.endIndex)+"</pre>"},{run:function(e){var t,n,i,s=e.path,d=e.code,a=e.isNotUsingDCBN,u="",c=0,f=0,l=1,_=1,p=0,m=0,I=[0],E=!1,v=!1,h=!1,C=!1,S=!1,g=!1,L=!1,y=!1,k=!1,R=function(){return E===!0||h===!0||C===!0||S===!0},T=function(){return g===!0||L===!0||y===!0||k===!0},N=function(){I[I.length-1]+=1,u+="__pauseCount += 1;",u+="__store.resume = resume = function() { __pauseCount -= 1; if (__pauseCount === 0 && __store.doneResumeIndexes["+c+"] !== true) { __store.doneResumeIndexes["+c+"] = true;"},x=function(){u+="var __pauseCount = 0;",u+="var __lastCondition;",u+="var __store = { doneResumeIndexes: {} };",u+="var resume;",u+="var pause = "+function(){__pauseCount+=1}.toString()+";",u+="var include = "+function(e){LOAD_NSP({requestInfo:__requestInfo,path:__basePath+"/"+e,self:self},{notExists:function(){print(e+": File not exists."),resume()},error:function(e,t,n,i,o,r,s,d){print(NSP.generateErrorDisplay({path:t,startIndex:s,endIndex:d,startLine:n,startColumn:i,endLine:o,endColumn:r,error:e}))},success:function(e){print(e.html),resume()}}),pause()}.toString()+";",N()};for(r[s]=d,RUN(function(){u+="var __html = '';",u+="var __redirectURL;",u+="var __cookieInfo = __requestInfo.cookies;",u+="var __newCookieInfo = {};",u+="var __path = '"+s+"';",u+="var __basePath = '"+o.dirname(s)+"';",u+="var print = "+function(e){void 0!==e&&("string"==typeof e?__html+=e:__html+=JSON.stringify(e))}.toString()+";",u+="var save = "+function(e,t){void 0===t?NSP.getSharedStore().remove(e):NSP.getSharedStore().save({name:e,value:t})}.toString()+";",u+="var load = "+function(e){return NSP.getSharedStore().get(e)}.toString()+";",u+="var cookie = "+function(e,t,n,i,o){return void 0===t?(t=__cookieInfo[e],CHECK_IS_DATA(t)===!0?t.value:t):(__newCookieInfo[e]=__cookieInfo[e]={value:t,expireSeconds:n,path:i,domain:o},t)}.toString()+";",u+="var upload = "+function(e,t){var n,i,o;CHECK_IS_DATA(t)!==!0?n=t:(n=t.success,i=t.error,o=t.overFileSize),UPLOAD_REQUEST({requestInfo:__requestInfo,uploadPath:__basePath+"/"+e},{error:i,overFileSize:o,success:n})}.toString()+";",u+="var redirect = "+function(e){__redirectURL=e}.toString()+";",u+="var __each = "+function(e,t){isNaN(e)===!0?EACH(e,function(e,n){t(n,e)}):REPEAT(e,function(e){t(void 0,e)})}.toString()+";",x(),u+="print('"});c<d.length;c+=1)if(p+=1,n=d[c],i=n+d[c+1],"<%"!==i||R()===!0)if("%>"!==i||T()===!0||E!==!0)if("<?"!==i||R()===!0)if("<~"!==i||R()===!0)if("->"!==i||T()===!0||C!==!0)if(":"!==n||T()===!0||C!==!0)if("el"!==i||"s"!==d[c+2]||"e"!==d[c+3]||" "!==d[c+4]&&"	"!==d[c+4]&&">"!==d[c+4]&&"\r"!==d[c+4]&&"\n"!==d[c+4]||T()===!0||h!==!0){if(">"===n&&T()!==!0){if(h===!0){h=!1,I.push(0),u+=") === true) { (function(__parentPause, __parentStore) {",x(),u+="print('";continue}if(C===!0){C=!1,I.push(0),u+=") { (function(__parentPause, __parentStore) {",x(),u+="print('";continue}}if("</"===i&&">"===d[c+3]&&R()!==!0){if("?"===d[c+2]){u+="');",REPEAT(I[I.length-1],function(e){0===e&&(u+="__parentStore.resume();"),u+="} }; resume();"}),I.pop(),u+="__parentPause(); } )(pause, __store); } } catch(e) { __errorHandler(e, __path, "+_+", "+m+", "+l+", "+(p+3)+", "+f+", "+(c+4)+"); }",N(),u+="print('",c+=3,p+=3;continue}if("~"===d[c+2]){u+="');",REPEAT(I[I.length-1],function(e){0===e&&(u+="__parentStore.resume();"),u+="} }; resume();"}),I.pop(),u+="__parentPause(); } )(pause, __store); } ); } catch(e) { __errorHandler(e, __path, "+_+", "+m+", "+l+", "+(p+3)+", "+f+", "+(c+4)+"); }",N(),u+="print('",c+=3,p+=3;continue}}if(a===!0||"{{"!==i||R()===!0)if(a===!0||"}}"!==i||T()===!0||S!==!0){if("'"===n){if(R()!==!0){u+="\\'";continue}if(T()!==!0){g=!0,u+="'";continue}if(g===!0){g=!1,u+="'";continue}}if('"'===n&&R()===!0){if(T()!==!0){L=!0,u+="'";continue}if(L===!0){L=!1,u+="'";continue}}if("//"!==i||R()!==!0||T()===!0)if("/*"!==i||R()!==!0||T()===!0)if("*/"!==i||R()!==!0||k!==!0){if("\n"===n){if(l+=1,p=0,R()===!0&&y===!0){y=!1,u+="\n";continue}if(R()!==!0){u+="\\n";continue}}"\\"!==n||R()===!0?"\r"!==n&&(u+=n):u+="\\\\"}else k=!1,u+="*/",c+=1,p+=1;else k=!0,u+="/*",c+=1,p+=1;else y=!0,u+="//",c+=1,p+=1}else S=!1,u+="); } catch(e) { __errorHandler(e, __path, "+_+", "+m+", "+l+", "+(p+1)+", "+f+", "+(c+2)+"); }",N(),u+="print('",c+=1,p+=1;else S=!0,u+="'); try { print(",_=l,m=p,f=c,c+=1,p+=1}else u+="__lastCondition !== true",c+=3,p+=3;else u+=", ";else for(u+=", function(",c+=1,p+=1,t=c+1;t<d.length;t+=1){if(">"===d[t]){u+="__name, ";break}if(":"===d[t])break}else C=!0,u+="'); try { __each(",_=l,m=p,f=c,c+=1,p+=1;else h=!0,u+="'); try { if (__lastCondition = (",_=l,m=p,f=c,c+=1,p+=1;else E=!1,v===!0&&(v=!1,u+=");"),u+="} catch(e) { __errorHandler(e, __path, "+_+", "+m+", "+l+", "+(p+1)+", "+f+", "+(c+2)+"); }",N(),u+="print('",c+=1,p+=1;else E=!0,u+="'); try {",_=l,m=p,f=c,"="===d[c+2]?(v=!0,u+="print(",c+=2,p+=2):(c+=1,p+=1);return u+="'); __handler({ html: __html, cookies: __newCookieInfo, redirectURL: __redirectURL });",REPEAT(I[0],function(){u+="} }; resume();"}),u}}}),global.NSP_BRIDGE=METHOD(function(e){var t=require("path"),n=function(e,t,n,i,o,r,s,d,a){e({statusCode:500,content:'<!doctype html><html><head><meta charset="UTF-8"><title>'+t+"</title></head><body>"+NSP.generateErrorDisplay({path:n,startIndex:d,endIndex:a,startLine:i,startColumn:o,endLine:r,endColumn:s,error:t})+"</body></html>",contentType:"text/html"})},i=function(e){e({statusCode:404,content:'<!doctype html><html><head><meta charset="UTF-8"><title>Page not found.</title></head><body><p><b>Page not found.</b></p></body></html>',contentType:"text/html"})};return{run:function(e){var o=e.rootPath,r=e.restURI,s=e.isNotUsingDCBN;return{notExistsHandler:function(e,t,n){i(n)},requestListener:function(e,d,a,u,c){var f,l,_=e.uri,p="",m=function(){LOAD_NSP({requestInfo:e,path:f,self:{headers:e.headers,method:e.method,params:e.params,ip:e.ip,subURI:p},isNotUsingDCBN:s},{notExists:function(){i(d)},error:function(e,t,i,o,r,s,a,u){n(d,e,t,i,o,r,s,a,u)},success:function(e){d(void 0!==e.redirectURL?{statusCode:302,headers:{"Set-Cookie":CREATE_COOKIE_STR_ARRAY(e.cookies),Location:e.redirectURL}}:{headers:{"Set-Cookie":CREATE_COOKIE_STR_ARRAY(e.cookies)},content:e.html,contentType:"text/html"})}})};return NEXT([function(e){""===_?CHECK_IS_EXISTS_FILE(o+"/index.nsp",function(t){_=t===!0?"index.nsp":"index.html",e()}):e()},function(){return function(){f=o+"/"+_,l=t.extname(_).toLowerCase(),".nsp"===l?m():""===l?NEXT([function(e){CHECK_IS_EXISTS_FILE(f+".nsp",function(t){t===!0?CHECK_IS_FOLDER(f+".nsp",function(t){t===!0?e():(f+=".nsp",m())}):e()})},function(e){return function(){void 0!==r?(CHECK_IS_ARRAY(r)===!0?CHECK_IS_IN({array:r,value:_})===!0?_=r+".nsp":EACH(r,function(e){return e+"/"===_.substring(0,e.length+1)?(p=_.substring(e.length+1),_=e+".nsp",!1):void 0}):r===_?_=r+".nsp":r+"/"===_.substring(0,r.length+1)&&(p=_.substring(r.length+1),_=r+".nsp"),CHECK_IS_EXISTS_FILE(o+"/"+_,function(t){t===!0?(f=o+"/"+_,m()):e()})):e()}},function(){return function(){CHECK_IS_EXISTS_FILE(f,function(e){e===!0?CHECK_IS_FOLDER(f,function(e){e===!0?(f+="/index.nsp",m()):c()}):c()})}}]):c()}}]),!1}}}}}),OVERRIDE(Life.ArticleLikeModel,function(e){"use strict";Life.ArticleLikeModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({articleId:1,userId:1}),e.on("create",{before:function(e,n,i,o){return NEXT([function(t){var n;void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(n=PARSE_COOKIE_STR(o.headers.cookie),void 0!==n["session-key"]&&Life.SessionKeyModel.get(n["session-key"],function(n){e.userId=n.userId,t()}))},function(){return function(){t.checkIsExists({filter:{articleId:e.articleId,userId:e.userId}},function(e){e===!0?i({validErrors:{articleId:{type:"existed"}}}):n()})}}]),!1},after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{likeCount:1}})}}),e.on("remove",{after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{likeCount:-1}})}})}})}),OVERRIDE(Life.ArticleModel,function(e){"use strict";Life.ArticleModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({boardId:1}),e.on("create",{before:function(e,t,n,i){var o;return NEXT([function(t){void 0===e.content?(e.html=void 0,t()):Life.ReplaceUserTagToLink(Markdown.MarkUp(e.content),function(n){e.html=n,t()})},function(){return function(){void 0===i?t():void 0!==i.headers&&void 0!==i.headers.cookie&&(o=PARSE_COOKIE_STR(i.headers.cookie),void 0!==o["session-key"]&&Life.SessionKeyModel.get(o["session-key"],function(n){e.writerId=n.userId,t()}))}}]),!1},after:function(e){Life.UserModel.updateNoHistory({id:e.writerId,lastArticleTime:new Date,$inc:{articleCount:1}}),Life.BoardModel.updateNoHistory({id:e.boardId,lastArticleTime:new Date,$inc:{articleCount:1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,lastArticleTime:new Date,$inc:{articleCount:1}})}}),e.on("update",{before:function(e,n,i,o){var r;return NEXT([function(t){e.content===TO_DELETE?(e.html=TO_DELETE,t()):void 0!==e.content?Life.ReplaceUserTagToLink(Markdown.MarkUp(e.content),function(n){e.html=n,t()}):t()},function(){return function(){void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e.id,function(t){e.writerId===i.userId?n():Life.UserModel.get(i.userId,function(e){CHECK_IS_IN({array:e.roles,value:Life.ROLE.MANAGER})===!0&&n()})})}))}}]),!1},after:function(e,t){Life.BoardModel.updateNoHistory({id:e.boardId,$inc:{articleCount:1}}),Life.BoardModel.updateNoHistory({id:t.boardId,$inc:{articleCount:-1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,$inc:{articleCount:1}}),void 0!==t.categoryId&&Life.CategoryModel.updateNoHistory({id:t.categoryId,$inc:{articleCount:-1}})}}),e.on("remove",{before:function(e,n,i,o){var r;return void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e,function(e){e.writerId===i.userId&&n()})})),!1},after:function(e){Life.BoardModel.updateNoHistory({id:e.boardId,$inc:{articleCount:-1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,$inc:{articleCount:-1}})}})}})}),OVERRIDE(Life.BoardModel,function(e){"use strict";Life.BoardModel=OBJECT({preset:function(){return e},init:function(e,t,n){var i,o;e.on("create",{before:function(e,n){return void 0===e.description?e.html=void 0:e.html=Markdown.MarkUp(e.description),t.get({sort:{index:-1}},{notExists:function(){e.index=0,n()},success:function(t){e.index=t.index+1,n()}}),!1}}),e.on("update",{before:function(e,t,n,i){void 0===e.description?e.html=void 0:e.html=Markdown.MarkUp(e.description),void 0!==i&&delete e.index}}),t.moveUp=i=function(e,n){t.get(e,function(e){t.get({filter:{index:{$lt:e.index}},sort:{index:-1}},{notExists:n,success:function(i){var o=i.index;t.updateNoHistory({id:i.id,index:e.index}),t.updateNoHistory({id:e.id,index:o}),n()}})})},t.moveDown=o=function(e,n){t.get(e,function(e){t.get({filter:{index:{$gt:e.index}},sort:{index:1}},{notExists:n,success:function(i){var o=i.index;t.updateNoHistory({id:i.id,index:e.index}),t.updateNoHistory({id:e.id,index:o}),n()}})})}}})}),OVERRIDE(Life.CommentLikeModel,function(e){"use strict";Life.CommentLikeModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({commentId:1,userId:1}),e.on("create",{before:function(e,n,i,o){return NEXT([function(t){var n;void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(n=PARSE_COOKIE_STR(o.headers.cookie),void 0!==n["session-key"]&&Life.SessionKeyModel.get(n["session-key"],function(n){e.userId=n.userId,t()}))},function(){return function(){t.checkIsExists({filter:{commentId:e.commentId,userId:e.userId}},function(e){e===!0?i({validErrors:{commentId:{type:"existed"}}}):n()})}}]),!1},after:function(e){Life.CommentModel.updateNoHistory({id:e.commentId,$inc:{likeCount:1}})}}),e.on("remove",{after:function(e){Life.CommentModel.updateNoHistory({id:e.commentId,$inc:{likeCount:-1}})}})}})}),OVERRIDE(Life.CommentModel,function(e){"use strict";Life.CommentModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({articleId:1}),e.on("create",{before:function(e,t,n,i){var o;return void 0===i?t():void 0!==i.headers&&void 0!==i.headers.cookie&&(o=PARSE_COOKIE_STR(i.headers.cookie),void 0!==o["session-key"]&&Life.SessionKeyModel.get(o["session-key"],function(n){e.writerId=n.userId,t()})),!1},after:function(e){Life.UserModel.updateNoHistory({id:e.writerId,lastCommentTime:new Date,$inc:{commentCount:1}}),Life.ArticleModel.updateNoHistory({id:e.articleId,lastCommentTime:new Date,$inc:{commentCount:1}})}}),e.on("update",{before:function(e,n,i,o){var r;return void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e.id,function(e){e.writerId===i.userId&&n()})})),!1}}),e.on("remove",{before:function(e,n,i,o){var r;return void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e,function(e){e.writerId===i.userId&&n()})})),!1},after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{commentCount:-1}})}})}})}),OVERRIDE(Life.UserModel,function(e){"use strict";Life.UserModel=OBJECT({preset:function(){return e},init:function(e,t,n){var i;t.getDB().createIndex({nickname:1}),e.on("create",{before:function(e,n,i){return void 0===e.intoduce?e.html=void 0:e.html=Markdown.MarkUp(e.intoduce),t.checkIsExists({filter:{username:e.username}},function(o){o===!0?i({validErrors:{username:{type:"existed"}}}):t.checkIsExists({filter:{nickname:e.nickname}},function(t){t===!0?i({validErrors:{nickname:{type:"existed"}}}):(e.password=SHA256({key:e.username,password:e.password}),delete e.isBanned,delete e.isLeft,e.roles=[Life.ROLE.USER],n())})}),!1},after:function(e){delete e.password,Life.JoinKeyModel.find({filter:{email:e.email},isFindAll:!0},EACH(function(e){Life.JoinKeyModel.remove(e.id)}))}}),e.on("update",{before:function(e,n,i,o){var r;return void 0===e.intoduce?e.html=void 0:e.html=Markdown.MarkUp(e.intoduce),delete e.email,delete e.isBanned,delete e.isLeft,NEXT([function(t){void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(n){e.id===n.userId&&t()}))},function(){return function(){t.get(e.id,function(o){NEXT([function(n){e.username===o.username?(void 0!==e.password&&(e.password=SHA256({key:o.username,password:e.password})),n()):void 0!==e.username?t.checkIsExists({filter:{username:e.username}},function(t){t===!0?i({validErrors:{username:{type:"existed"}}}):t===!1&&(void 0!==e.password&&(e.password=SHA256({key:e.username,password:e.password})),n())}):void 0!==e.password?(e.password=SHA256({key:o.username,password:e.password}),n()):n()},function(n){return function(){void 0!==e.nickname&&e.nickname!==o.nickname?t.checkIsExists({filter:{nickname:e.nickname}},function(e){e===!0?i({validErrors:{nickname:{type:"existed"}}}):n()}):n()}},function(){return function(){void 0!==e.iconFileId?IMAGEMAGICK_RESIZE({srcPath:"__RF/Life/"+e.iconFileId,distPath:"__RF/Life/ICON/"+e.iconFileId,width:40,height:40},n):n()}}])})}}]),!1},after:function(e){delete e.password}}),e.on("get",function(e){delete e.password}),e.on("find",EACH(function(e){delete e.password})),t.login=i=function(e,n){t.get({filter:{username:e.username,password:SHA256({key:e.username,password:e.password})}},{notExists:function(){n.notValid()},success:function(e){e.isLeft===!0?n.notValid():Life.SessionKeyModel.create({userId:e.id},function(i){t.updateNoHistory({id:e.id,lastLoginTime:new Date,$inc:{loginCount:1}},function(e){n.success(e,i.id)})})}})}}})});