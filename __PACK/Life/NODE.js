Life.GenerateNotiMessage=METHOD({run:function(e,t){"comment"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.ArticleModel.get(e.targetId,function(e){t("/board/all/"+e.id,i.nickname+"님이 ["+e.title+"]에 댓글을 남겼습니다.")})}):"like-article"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.ArticleModel.get(e.targetId,function(e){t("/board/all/"+e.id,i.nickname+"님이 ["+e.title+"]을 좋아합니다.")})}):"like-comment"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.CommentModel.get(e.targetId,function(e){t("/board/all/"+e.articleId,i.nickname+"님이 댓글 ["+e.content+"]을 좋아합니다.")})}):"tag-article"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.ArticleModel.get(e.targetId,function(e){t("/board/all/"+e.id,i.nickname+"님이 ["+e.title+"]에 나를 태그했습니다.")})}):"tag-comment"===e.type&&Life.UserModel.get(e.targetUserId,function(i){Life.CommentModel.get(e.targetId,function(e){t("/board/all/"+e.articleId,i.nickname+"님이 댓글 ["+e.content+"]에 나를 태그했습니다.")})})}}),Life.ReplaceUserTagToLink=METHOD({run:function(e,t){var i,n,r=0;(n=function(){for(i=void 0;r<e.length+1;r+=1){if(void 0!==i&&(r===e.length||"@"===e[r]||" "===e[r]||"	"===e[r]||"\n"===e[r]||"\r"===e[r]||"<"===e[r]))return void Life.UserModel.get({filter:{nickname:e.substring(i,r)}},{notExists:function(){n()},success:function(t){var o='<a href="/user/'+t.id+'">'+t.nickname+"</a>";e=e.substring(0,i-1)+o+(r<e.length?e.substring(r):""),r+=o.length-(r-i)-1,n()}});r<e.length&&"@"===e[r]&&(i=r+1)}t(e)})()}}),Life.ArticleLikeModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={articleId:{notEmpty:!0,id:!0},userId:{notEmpty:!0,id:!0}};return{name:"ArticleLike",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.ArticleModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={boardId:{notEmpty:!0,id:!0},categoryId:{id:!0},writerId:{notEmpty:!0,id:!0},title:{notEmpty:!0,size:{max:255}},content:{size:{max:3e4}},html:!0,viewCount:{notEmpty:!0,integer:!0},lastViewTime:{date:!0},commentCount:{notEmpty:!0,integer:!0},lastCommentTime:{date:!0},likeCount:{notEmpty:!0,integer:!0}};return{name:"Article",initData:{viewCount:0,commentCount:0,likeCount:0},methodConfig:{create:{valid:VALID(e),authKey:"writerId",role:Life.ROLE.USER},update:{valid:VALID(e),authKey:"writerId",role:Life.ROLE.USER},remove:{authKey:"writerId",role:Life.ROLE.USER}}}}}),Life.BoardModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={name:{notEmpty:!0,size:{max:255}},description:{size:{max:3e3}},html:!0,index:{real:!0},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Board",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:Life.ROLE.MANAGER},update:{valid:VALID(e),role:Life.ROLE.MANAGER},remove:{role:Life.ROLE.MANAGER}}}}}),Life.CategoryModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={boardId:{notEmpty:!0,id:!0},category:{notEmpty:!0,size:{max:255}},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Category",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:Life.ROLE.MANAGER},update:{valid:VALID(e),role:Life.ROLE.MANAGER},remove:{role:Life.ROLE.MANAGER}}}}}),Life.ChatModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={writerId:{notEmpty:!0,id:!0},content:{notEmpty:!0,size:{max:1e3}}};return{name:"Chat",isNotUsingHistory:!0,methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.CommentLikeModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={commentId:{notEmpty:!0,id:!0},userId:{notEmpty:!0,id:!0}};return{name:"CommentLike",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.CommentModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={writerId:{notEmpty:!0,id:!0},articleId:{notEmpty:!0,id:!0},content:{notEmpty:!0,size:{max:1e3}},likeCount:{notEmpty:!0,integer:!0}};return{name:"Comment",initData:{likeCount:0},methodConfig:{create:{valid:VALID(e)},update:{valid:VALID(e)}}}}}),Life.JoinKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"JoinKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.NotiModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={userId:{notEmpty:!0,id:!0},targetUserId:{notEmpty:!0,id:!0},type:{notEmpty:!0,one:["comment","like-article","liek-comment","tag-article","tag-comment"]},targetId:{id:!0}};return{name:"Noti",isNotUsingHistory:!0,methodConfig:{create:{valid:VALID(e),role:Life.ROLE.ADMIN},update:!1,remove:!1}}}}),Life.ResetEmailKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"ResetEmailKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.ResetPasswordKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"ResetPasswordKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.SessionKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"SessionKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.UserModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={username:{notEmpty:!0,size:{min:4,max:20},username:!0},nickname:{notEmpty:!0,size:{min:2,max:20}},email:{notEmpty:!0,size:{min:5,max:320},email:!0},password:{notEmpty:!0,size:{min:4,max:20}},loginCount:{notEmpty:!0,integer:!0},lastLoginTime:{date:!0},isBanned:{bool:!0},isLeft:{bool:!0},isAgreedTerms:{notEmpty:!0,equal:!0},isAgreedPrivacy:{notEmpty:!0,equal:!0},roles:{array:!0},iconFileId:{id:!0},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0},lastCommentTime:{date:!0},commentCount:{notEmpty:!0,integer:!0},intoduce:{size:{max:3e4}},html:!0};return{name:"User",initData:{loginCount:0,articleCount:0,commentCount:0},methodConfig:{create:{valid:VALID(e)},update:{valid:VALID(e)},remove:!1},loginValid:VALID({username:e.username,password:e.password})}}}),Life("ROLE").ADMIN="Admin",Life("ROLE").MANAGER="Manager",Life("ROLE").USER="User";global.LOAD_NSP=METHOD(function(e){var t={};return{run:function(e,n){var i=e.requestInfo,o=e.path,r=e.self,s=e.isNotUsingDCBN,d=e.preprocessor,c=n.notExists,a=n.error,u=n.success;GET_FILE_INFO(o,{notExists:c,success:function(e){var n=t[o];void 0!==n&&(void 0!==e.lastUpdateTime&&n.lastUpdateTime.getTime()===e.lastUpdateTime.getTime()||void 0!==e.createTime&&n.lastUpdateTime.getTime()===e.createTime.getTime())?n.run(i,r,a,u):READ_FILE(o,{notExists:c,error:a,success:function(n){var c=new Function("__requestInfo","self","__errorHandler","__handler",NSP({path:o,code:n.toString(),isNotUsingDCBN:s,preprocessor:d}));t[o]={lastUpdateTime:void 0===e.lastUpdateTime?e.createTime:e.lastUpdateTime,run:c},c(i,r,a,u)}})}})}}}),Life.MAIN=METHOD({run:function(e){"use strict";var t=require("less");e(NSP_BRIDGE({rootPath:"./Life/view",restURI:["account/create","board","article","user","account/reset-password","account/verify-email"]}).requestListener),RESOURCE_SERVER.addPreprocessor({extension:"less",preprocessor:function(e,n){t.render(e,function(e,t){n({content:t.css,contentType:"text/css",version:CONFIG.version})})}}),UMAIL.CONNECT_TO_MAIL_SERVER({host:"smtp.gmail.com",port:465,isSecure:!0,username:NODE_CONFIG.Life.email,password:NODE_CONFIG.Life.emailPassword},function(e){Life.sendMail=e})}}),global.NSP=METHOD(function(e){var t,n,i,o=require("path"),r={},s=SHARED_STORE("__NSP_SHARED_STORE");return e.getSavedCodes=t=function(){return r},e.getSharedStore=n=function(){return s},e.generateErrorDisplay=i=function(e){var t="";return t+="<p><b>"+e.error+"</b></p>",t+="<p><b>path: </b>"+e.path+" ("+e.startLine+":"+e.startColumn+"~"+e.endLine+":"+e.endColumn+")</p>",t+="<pre>"+r[e.path].substring(e.startIndex,e.endIndex)+"</pre>"},e.require=require,{run:function(e){var t,n,i,s,d,c,a,u,f,l=e.path,_=e.code,p=e.isNotUsingDCBN,I=e.preprocessor,m="",E=0,v=0,h=1,C=1,g=0,L=0,S=[0],y=!1,k=!1,R=!1,T=!1,N=!1,M=!1,O=!1,x=!1,A=!1,w=function(){return y===!0||R===!0||T===!0||N===!0},D=function(){return M===!0||O===!0||x===!0||A===!0},H=function(){S[S.length-1]+=1,m+="__pauseCount += 1;",m+="__store.resume = resume = function() { __pauseCount -= 1; if (__pauseCount === 0 && __store.doneResumeIndexes["+E+"] !== true) { __store.doneResumeIndexes["+E+"] = true;"},U=function(e){m+="var __pauseCount = 0;",m+="var __lastCondition;",m+="var __store = { doneResumeIndexes: {} };",m+="var resume;",m+="var pause = "+function(){__pauseCount+=1}.toString()+";",m+="var include = "+function(e){LOAD_NSP({requestInfo:__requestInfo,path:__basePath+"/"+e,self:self},{notExists:function(){print(e+": File not exists."),resume()},error:function(e,t,n,i,o,r,s,d){print(NSP.generateErrorDisplay({path:t,startIndex:s,endIndex:d,startLine:n,startColumn:i,endLine:o,endColumn:r,error:e}))},success:function(e){print(e.html),resume()}}),pause()}.toString()+";",e===!0?m+="__store.resume = resume = function() { __pauseCount -= 1; };":H()};for(r[l]=_,RUN(function(){m+="var __html = '';",m+="var __redirectURL;",m+="var __cookieInfo = __requestInfo.cookies;",m+="var __newCookieInfo = {};",m+="var __basePath = '"+o.dirname(l)+"';",m+="var print = "+function(e){void 0!==e&&("string"==typeof e?__html+=e:__html+=JSON.stringify(e))}.toString()+";",m+="var save = "+function(e,t){void 0===t?NSP.getSharedStore().remove(e):NSP.getSharedStore().save({name:e,value:t})}.toString()+";",m+="var load = "+function(e){return NSP.getSharedStore().get(e)}.toString()+";",m+="var cookie = "+function(e,t,n,i,o){return void 0===t?(t=__cookieInfo[e],CHECK_IS_DATA(t)===!0?t.value:t):(__newCookieInfo[e]=__cookieInfo[e]={value:t,expireSeconds:n,path:i,domain:o},t)}.toString()+";",m+="var upload = "+function(e,t){var n,i,o;CHECK_IS_DATA(t)!==!0?n=t:(n=t.success,i=t.error,o=t.overFileSize),UPLOAD_REQUEST({requestInfo:__requestInfo,uploadPath:__basePath+"/"+e},{error:i,overFileSize:o,success:n})}.toString()+";",m+="var redirect = "+function(e){__redirectURL=e}.toString()+";",m+="var __each = "+function(e,t){isNaN(e)===!0?EACH(e,function(e,n){t(n,e)}):REPEAT(e,function(e){t(void 0,e)})}.toString()+";",U(!0),m+="print('"});E<_.length;E+=1)if(g+=1,s=_[E],d=s+_[E+1],"<%"!==d||w()===!0)if("%>"!==d||D()===!0||y!==!0)if("<?"!==d||w()===!0)if("<~"!==d||w()===!0)if("->"!==d||D()===!0||T!==!0)if(":"!==s||D()===!0||T!==!0)if("el"!==d||"s"!==_[E+2]||"e"!==_[E+3]||" "!==_[E+4]&&"	"!==_[E+4]&&">"!==_[E+4]&&"\r"!==_[E+4]&&"\n"!==_[E+4]||D()===!0||R!==!0){if(">"===s&&D()!==!0){if(R===!0){R=!1,S.push(0),m+=") === true) { (function(__parentPause, __parentStore) {",U(),m+="print('";continue}if(T===!0){T=!1,S.push(0),-1===i&&(m+=", function(__name, __value"),m+=") { (function(__parentPause, __parentStore) {",U(),m+="print('";continue}}if("</"===d&&">"===_[E+3]&&w()!==!0){if("?"===_[E+2]){m+="');",REPEAT(S[S.length-1],function(e){0===e&&(m+="__parentStore.resume();"),m+="} }; resume();"}),S.pop(),m+="__parentPause(); } )(pause, __store); } } catch(e) { __errorHandler(e, __path, "+C+", "+L+", "+h+", "+(g+3)+", "+v+", "+(E+4)+"); }",H(),m+="print('",E+=3,g+=3;continue}if("~"===_[E+2]){m+="');",REPEAT(S[S.length-1],function(e){0===e&&(m+="__parentStore.resume();"),m+="} }; resume();"}),S.pop(),m+="__parentPause(); } )(pause, __store); } ); } catch(e) { __errorHandler(e, __path, "+C+", "+L+", "+h+", "+(g+3)+", "+v+", "+(E+4)+"); }",H(),m+="print('",E+=3,g+=3;continue}}if(p===!0||"{{"!==d||w()===!0)if(p===!0||"}}"!==d||D()===!0||N!==!0){if("'"===s){if(w()!==!0){m+="\\'";continue}if(D()!==!0){M=!0,m+="'";continue}if(M===!0){M=!1,m+="'";continue}}if('"'===s&&w()===!0){if(D()!==!0){O=!0,m+="'";continue}if(O===!0){O=!1,m+="'";continue}}if("//"!==d||w()!==!0||D()===!0)if("/*"!==d||w()!==!0||D()===!0)if("*/"!==d||w()!==!0||A!==!0){if("\n"===s){if(h+=1,g=0,w()===!0&&x===!0){x=!1,m+="\n";continue}if(w()!==!0){m+="\\n";continue}}"\\"!==s||w()===!0?"\r"!==s&&(m+=s):m+="\\\\"}else A=!1,m+="*/",E+=1,g+=1;else A=!0,m+="/*",E+=1,g+=1;else x=!0,m+="//",E+=1,g+=1}else N=!1,m+="); } catch(e) { __errorHandler(e, __path, "+C+", "+L+", "+h+", "+(g+1)+", "+v+", "+(E+2)+"); }",H(),m+="print('",E+=1,g+=1;else N=!0,m+="'); try { print(",C=h,L=g,v=E,E+=1,g+=1}else m+="__lastCondition !== true",E+=3,g+=3;else m+=", ";else for(m+=", function(",E+=1,g+=1,i=E+1;i<_.length;i+=1){if(">"===_[i]){m+="__name, ";break}if(":"===_[i])break}else T=!0,m+="'); try { __each(",C=h,L=g,v=E,E+=1,i=-1,g+=1;else R=!0,m+="'); try { if (__lastCondition = (",C=h,L=g,v=E,E+=1,g+=1;else y=!1,k===!0&&(k=!1,m+=");"),void 0===n?(n=E+2,a=h,f=g+1):m+="} catch(e) { __errorHandler(e, __path, "+C+", "+L+", "+h+", "+(g+1)+", "+v+", "+(E+2)+"); }",H(),m+="print('",E+=1,g+=1;else y=!0,C=h,L=g,v=E,void 0===t?(t=E,c=h,u=g,m+="');"):m+="'); try {","="===_[E+2]?(k=!0,m+="print(",E+=2,g+=2):(E+=1,g+=1);return m+="'); __handler({ html: __html, cookies: __newCookieInfo, redirectURL: __redirectURL });",REPEAT(S[0],function(){m+="} }; resume();"}),void 0!==I&&(m=I(m)),void 0!==t&&(m="try {"+m+"} catch(e) { __errorHandler(e, __path, "+c+", "+u+", "+a+", "+f+", "+t+", "+n+"); }"),m="var __path = '"+l+"';"+m,m="var require = NSP.require;"+m}}}),global.NSP_BRIDGE=METHOD(function(e){var t=require("path"),n=function(e,t,n,i,o,r,s,d,c){e({statusCode:500,content:'<!doctype html><html><head><meta charset="UTF-8"><title>'+t+"</title></head><body>"+NSP.generateErrorDisplay({path:n,startIndex:d,endIndex:c,startLine:i,startColumn:o,endLine:r,endColumn:s,error:t})+"</body></html>",contentType:"text/html"})},i=function(e){e({statusCode:404,content:'<!doctype html><html><head><meta charset="UTF-8"><title>Page not found.</title></head><body><p><b>Page not found.</b></p></body></html>',contentType:"text/html"})};return{run:function(e){var o=e.rootPath,r=e.restURI,s=e.isNotUsingDCBN,d=e.preprocessor;return{notExistsHandler:function(e,t,n){i(n)},requestListener:function(e,c,a,u,f){var l,_,p=e.uri,I="",m=function(){LOAD_NSP({requestInfo:e,path:l,self:{headers:e.headers,method:e.method,params:e.params,ip:e.ip,subURI:I},isNotUsingDCBN:s,preprocessor:d},{notExists:function(){i(c)},error:function(e,t,i,o,r,s,d,a){n(c,e,t,i,o,r,s,d,a)},success:function(e){c(void 0!==e.redirectURL?{statusCode:302,headers:{"Set-Cookie":CREATE_COOKIE_STR_ARRAY(e.cookies),Location:e.redirectURL}}:{headers:{"Set-Cookie":CREATE_COOKIE_STR_ARRAY(e.cookies)},content:e.html,contentType:"text/html"})}})};return NEXT([function(e){""===p?CHECK_IS_EXISTS_FILE(o+"/index.nsp",function(t){p=t===!0?"index.nsp":"index.html",e()}):e()},function(){return function(){l=o+"/"+p,_=t.extname(p).toLowerCase(),".nsp"===_?m():""===_?NEXT([function(e){CHECK_IS_EXISTS_FILE(l+".nsp",function(t){t===!0?CHECK_IS_FOLDER(l+".nsp",function(t){t===!0?e():(l+=".nsp",m())}):e()})},function(e){return function(){void 0!==r?(CHECK_IS_ARRAY(r)===!0?CHECK_IS_IN({array:r,value:p})===!0?p=r+".nsp":EACH(r,function(e){return e+"/"===p.substring(0,e.length+1)?(I=p.substring(e.length+1),p=e+".nsp",!1):void 0}):r===p?p=r+".nsp":r+"/"===p.substring(0,r.length+1)&&(I=p.substring(r.length+1),p=r+".nsp"),CHECK_IS_EXISTS_FILE(o+"/"+p,function(t){t===!0?(l=o+"/"+p,m()):e()})):e()}},function(){return function(){CHECK_IS_EXISTS_FILE(l,function(e){e===!0?CHECK_IS_FOLDER(l,function(e){e===!0?(l+="/index.nsp",m()):f()}):f()})}}]):f()}}]),!1}}}}}),OVERRIDE(Life.ArticleLikeModel,function(e){"use strict";Life.ArticleLikeModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({articleId:1,userId:1}),e.on("create",{before:function(e,n,i,o){return NEXT([function(t){var n;void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(n=PARSE_COOKIE_STR(o.headers.cookie),void 0!==n["session-key"]&&Life.SessionKeyModel.get(n["session-key"],function(n){e.userId=n.userId,t()}))},function(){return function(){t.checkIsExists({filter:{articleId:e.articleId,userId:e.userId}},function(e){e===!0?i({validErrors:{articleId:{type:"existed"}}}):n()})}}]),!1},after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{likeCount:1}},function(t){t.writerId!==e.userId&&Life.NotiModel.create({userId:t.writerId,targetUserId:e.userId,type:"like-article",targetId:t.id})})}}),e.on("remove",{after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{likeCount:-1}})}})}})}),OVERRIDE(Life.ArticleModel,function(e){"use strict";Life.ArticleModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({boardId:1}),e.on("create",{before:function(e,t,n,i){var o;return NEXT([function(t){void 0===e.content?(e.html=void 0,t()):Life.ReplaceUserTagToLink(Markdown.MarkUp(e.content),function(n){e.html=n,t()})},function(){return function(){void 0===i?t():void 0!==i.headers&&void 0!==i.headers.cookie&&(o=PARSE_COOKIE_STR(i.headers.cookie),void 0!==o["session-key"]&&Life.SessionKeyModel.get(o["session-key"],function(n){e.writerId=n.userId,t()}))}}]),!1},after:function(e){var t,n=e.content;Life.UserModel.updateNoHistory({id:e.writerId,lastArticleTime:new Date,$inc:{articleCount:1}}),Life.BoardModel.updateNoHistory({id:e.boardId,lastArticleTime:new Date,$inc:{articleCount:1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,lastArticleTime:new Date,$inc:{articleCount:1}}),REPEAT(n.length+1,function(i){void 0===t||i!==n.length&&"@"!==n[i]&&" "!==n[i]&&"	"!==n[i]&&"\n"!==n[i]&&"\r"!==n[i]&&"<"!==n[i]||Life.UserModel.get({filter:{nickname:n.substring(t,i)}},{notExists:function(){},success:function(t){t.id!==e.writerId&&Life.NotiModel.create({userId:t.id,targetUserId:e.writerId,type:"tag-article",targetId:e.id})}}),"@"===n[i]&&(t=i+1)})}}),e.on("update",{before:function(e,n,i,o){var r;return NEXT([function(t){e.content===TO_DELETE?(e.html=TO_DELETE,t()):void 0!==e.content?Life.ReplaceUserTagToLink(Markdown.MarkUp(e.content),function(n){e.html=n,t()}):t()},function(){return function(){void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e.id,function(t){e.writerId===i.userId?n():Life.UserModel.get(i.userId,function(e){CHECK_IS_IN({array:e.roles,value:Life.ROLE.MANAGER})===!0&&n()})})}))}}]),!1},after:function(e,t){Life.BoardModel.updateNoHistory({id:e.boardId,$inc:{articleCount:1}}),Life.BoardModel.updateNoHistory({id:t.boardId,$inc:{articleCount:-1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,$inc:{articleCount:1}}),void 0!==t.categoryId&&Life.CategoryModel.updateNoHistory({id:t.categoryId,$inc:{articleCount:-1}})}}),e.on("remove",{before:function(e,n,i,o){var r;return void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e,function(e){e.writerId===i.userId&&n()})})),!1},after:function(e){Life.BoardModel.updateNoHistory({id:e.boardId,$inc:{articleCount:-1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,$inc:{articleCount:-1}})}})}})}),OVERRIDE(Life.BoardModel,function(e){"use strict";Life.BoardModel=OBJECT({preset:function(){return e},init:function(e,t,n){var i,o;e.on("create",{before:function(e,n){return void 0===e.description?e.html=void 0:e.html=Markdown.MarkUp(e.description),t.get({sort:{index:-1}},{notExists:function(){e.index=0,n()},success:function(t){e.index=t.index+1,n()}}),!1}}),e.on("update",{before:function(e,t,n,i){void 0===e.description?e.html=void 0:e.html=Markdown.MarkUp(e.description),void 0!==i&&delete e.index}}),t.moveUp=i=function(e,n){t.get(e,function(e){t.get({filter:{index:{$lt:e.index}},sort:{index:-1}},{notExists:n,success:function(i){var o=i.index;t.updateNoHistory({id:i.id,index:e.index}),t.updateNoHistory({id:e.id,index:o}),n()}})})},t.moveDown=o=function(e,n){t.get(e,function(e){t.get({filter:{index:{$gt:e.index}},sort:{index:1}},{notExists:n,success:function(i){var o=i.index;t.updateNoHistory({id:i.id,index:e.index}),t.updateNoHistory({id:e.id,index:o}),n()}})})}}})}),OVERRIDE(Life.ChatModel,function(e){"use strict";Life.ChatModel=OBJECT({preset:function(){return e},init:function(e,t,n){var i=Life.SHARED_DB("connectionDB");i.save({id:"connectionCount",data:{count:0}}),Life.ROOM(t.getName(),function(e,n){i.update({id:"connectionCount",data:{$inc:{count:1}}}),Life.BROADCAST({roomName:t.getName(),methodName:"clientConnected",data:i.get("connectionCount").count}),n("__DISCONNECTED",function(){i.update({id:"connectionCount",data:{$inc:{count:-1}}}),Life.BROADCAST({roomName:t.getName(),methodName:"clientDisconnected",data:i.get("connectionCount").count})}),n("getConnectionCount",function(e,t){t(i.get("connectionCount").count)})})}})}),OVERRIDE(Life.CommentLikeModel,function(e){"use strict";Life.CommentLikeModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({commentId:1,userId:1}),e.on("create",{before:function(e,n,i,o){return NEXT([function(t){var n;void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(n=PARSE_COOKIE_STR(o.headers.cookie),void 0!==n["session-key"]&&Life.SessionKeyModel.get(n["session-key"],function(n){e.userId=n.userId,t()}))},function(){return function(){t.checkIsExists({filter:{commentId:e.commentId,userId:e.userId}},function(e){e===!0?i({validErrors:{commentId:{type:"existed"}}}):n()})}}]),!1},after:function(e){Life.CommentModel.updateNoHistory({id:e.commentId,$inc:{likeCount:1}},function(t){t.writerId!==e.userId&&Life.NotiModel.create({userId:t.writerId,targetUserId:e.userId,type:"like-comment",targetId:t.id})})}}),e.on("remove",{after:function(e){Life.CommentModel.updateNoHistory({id:e.commentId,$inc:{likeCount:-1}})}})}})}),OVERRIDE(Life.CommentModel,function(e){"use strict";Life.CommentModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({articleId:1}),e.on("create",{before:function(e,t,n,i){var o;return void 0===i?t():void 0!==i.headers&&void 0!==i.headers.cookie&&(o=PARSE_COOKIE_STR(i.headers.cookie),void 0!==o["session-key"]&&Life.SessionKeyModel.get(o["session-key"],function(n){e.writerId=n.userId,t()})),!1},after:function(e){var t,n=e.content;Life.UserModel.updateNoHistory({id:e.writerId,lastCommentTime:new Date,$inc:{commentCount:1}}),Life.ArticleModel.updateNoHistory({id:e.articleId,lastCommentTime:new Date,$inc:{commentCount:1}},function(t){t.writerId!==e.writerId&&Life.NotiModel.create({userId:t.writerId,targetUserId:e.writerId,type:"comment",targetId:e.articleId})}),REPEAT(n.length+1,function(i){void 0===t||i!==n.length&&"@"!==n[i]&&" "!==n[i]&&"	"!==n[i]&&"\n"!==n[i]&&"\r"!==n[i]&&"<"!==n[i]||Life.UserModel.get({filter:{nickname:n.substring(t,i)}},{notExists:function(){},success:function(t){t.id!==e.writerId&&Life.NotiModel.create({userId:t.id,targetUserId:e.writerId,type:"tag-comment",targetId:e.id})}}),"@"===n[i]&&(t=i+1)})}}),e.on("update",{before:function(e,n,i,o){var r;return void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e.id,function(e){e.writerId===i.userId&&n()})})),!1}}),e.on("remove",{before:function(e,n,i,o){var r;return void 0===o?n():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(i){t.get(e,function(e){e.writerId===i.userId&&n()})})),!1},after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{commentCount:-1}})}})}})}),OVERRIDE(Life.NotiModel,function(e){"use strict";Life.NotiModel=OBJECT({preset:function(){return e},init:function(e,t,n){t.getDB().createIndex({userId:1})}})}),OVERRIDE(Life.UserModel,function(e){"use strict";Life.UserModel=OBJECT({preset:function(){return e},init:function(e,t,n){var i;t.getDB().createIndex({nickname:1}),e.on("create",{before:function(e,n,i){return void 0===e.intoduce?e.html=void 0:e.html=Markdown.MarkUp(e.intoduce),t.checkIsExists({filter:{username:e.username}},function(o){o===!0?i({validErrors:{username:{type:"existed"}}}):t.checkIsExists({filter:{nickname:e.nickname}},function(t){t===!0?i({validErrors:{nickname:{type:"existed"}}}):(e.password=SHA256({key:e.username,password:e.password}),delete e.isBanned,delete e.isLeft,e.roles=[Life.ROLE.USER],n())})}),!1},after:function(e){delete e.password,Life.JoinKeyModel.find({filter:{email:e.email},isFindAll:!0},EACH(function(e){Life.JoinKeyModel.remove(e.id)}))}}),e.on("update",{before:function(e,n,i,o){var r;return void 0===e.intoduce||e.intoduce===TO_DELETE?e.html=void 0:e.html=Markdown.MarkUp(e.intoduce),void 0!==o&&delete e.email,delete e.isBanned,delete e.isLeft,NEXT([function(t){void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(n){e.id===n.userId&&t()}))},function(){return function(){t.get(e.id,function(o){NEXT([function(n){e.username===o.username?(void 0!==e.password&&(e.password=SHA256({key:o.username,password:e.password})),n()):void 0!==e.username?t.checkIsExists({filter:{username:e.username}},function(t){t===!0?i({validErrors:{username:{type:"existed"}}}):t===!1&&(void 0!==e.password&&(e.password=SHA256({key:e.username,password:e.password})),n())}):void 0!==e.password?(e.password=SHA256({key:o.username,password:e.password}),n()):n()},function(n){return function(){void 0!==e.nickname&&e.nickname!==o.nickname?t.checkIsExists({filter:{nickname:e.nickname}},function(e){e===!0?i({validErrors:{nickname:{type:"existed"}}}):n()}):n()}},function(){return function(){void 0!==e.iconFileId?IMAGEMAGICK_RESIZE({srcPath:"__RF/Life/"+e.iconFileId,distPath:"__RF/Life/ICON/"+e.iconFileId,width:40,height:40},n):n()}}])})}}]),!1},after:function(e){delete e.password}}),e.on("get",function(e){delete e.password}),e.on("find",EACH(function(e){delete e.password})),t.login=i=function(e,n){t.get({filter:{username:e.username,password:SHA256({key:e.username,password:e.password})}},{notExists:function(){n.notValid()},success:function(e){e.isLeft===!0?n.notValid():Life.SessionKeyModel.create({userId:e.id},function(i){t.updateNoHistory({id:e.id,lastLoginTime:new Date,$inc:{loginCount:1}},function(e){n.success(e,i.id)})})}})}}})});