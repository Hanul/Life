Life.GenerateNotiMessage=METHOD({run:function(e,t){"comment"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.ArticleModel.get(e.targetId,function(e){t("/board/all/"+e.id,i.nickname+"님이 ["+e.title+"]에 댓글을 남겼습니다.")})}):"like-article"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.ArticleModel.get(e.targetId,function(e){t("/board/all/"+e.id,i.nickname+"님이 ["+e.title+"]을 좋아합니다.")})}):"like-comment"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.CommentModel.get(e.targetId,function(e){t("/board/all/"+e.articleId,i.nickname+"님이 댓글 ["+e.content+"]을 좋아합니다.")})}):"tag-article"===e.type?Life.UserModel.get(e.targetUserId,function(i){Life.ArticleModel.get(e.targetId,function(e){t("/board/all/"+e.id,i.nickname+"님이 ["+e.title+"]에 나를 태그했습니다.")})}):"tag-comment"===e.type&&Life.UserModel.get(e.targetUserId,function(i){Life.CommentModel.get(e.targetId,function(e){t("/board/all/"+e.articleId,i.nickname+"님이 댓글 ["+e.content+"]에 나를 태그했습니다.")})})}}),Life.ReplaceUserTagToLink=METHOD({run:function(e,t){var i,n,r=0;(n=function(){for(i=void 0;r<e.length+1;r+=1){if(void 0!==i&&(r===e.length||"@"===e[r]||" "===e[r]||"\t"===e[r]||"\n"===e[r]||"\r"===e[r]||"<"===e[r]))return void Life.UserModel.get({filter:{nickname:e.substring(i,r)}},{notExists:function(){n()},success:function(t){var o='<a href="/user/'+t.id+'">'+t.nickname+"</a>";e=e.substring(0,i-1)+o+(r<e.length?e.substring(r):""),r+=o.length-(r-i)-1,n()}});r<e.length&&"@"===e[r]&&(i=r+1)}t(e)})()}}),Life.ArticleLikeModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={articleId:{notEmpty:!0,id:!0},userId:{notEmpty:!0,id:!0}};return{name:"ArticleLike",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.ArticleModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={boardId:{notEmpty:!0,id:!0},categoryId:{id:!0},writerId:{notEmpty:!0,id:!0},title:{notEmpty:!0,size:{max:255}},content:{size:{max:3e4}},html:!0,viewCount:{notEmpty:!0,integer:!0},lastViewTime:{date:!0},commentCount:{notEmpty:!0,integer:!0},lastCommentTime:{date:!0},likeCount:{notEmpty:!0,integer:!0}};return{name:"Article",initData:{viewCount:0,commentCount:0,likeCount:0},methodConfig:{create:{valid:VALID(e),authKey:"writerId",role:Life.ROLE.USER},update:{valid:VALID(e),authKey:"writerId",role:Life.ROLE.USER},remove:{authKey:"writerId",role:Life.ROLE.USER}}}}}),Life.BoardModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={name:{notEmpty:!0,size:{max:255}},description:{size:{max:3e3}},html:!0,index:{real:!0},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Board",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:Life.ROLE.MANAGER},update:{valid:VALID(e),role:Life.ROLE.MANAGER},remove:{role:Life.ROLE.MANAGER}}}}}),Life.CategoryModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={boardId:{notEmpty:!0,id:!0},category:{notEmpty:!0,size:{max:255}},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0}};return{name:"Category",initData:{articleCount:0},methodConfig:{create:{valid:VALID(e),role:Life.ROLE.MANAGER},update:{valid:VALID(e),role:Life.ROLE.MANAGER},remove:{role:Life.ROLE.MANAGER}}}}}),Life.ChatModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={writerId:{notEmpty:!0,id:!0},writerNickname:{size:{min:2,max:20}},writerIconFileId:{id:!0},content:{notEmpty:!0,size:{max:1e3}}};return{name:"Chat",isNotUsingHistory:!0,methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.CommentLikeModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={commentId:{notEmpty:!0,id:!0},userId:{notEmpty:!0,id:!0}};return{name:"CommentLike",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),Life.CommentModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={writerId:{notEmpty:!0,id:!0},articleId:{notEmpty:!0,id:!0},content:{notEmpty:!0,size:{max:1e3}},likeCount:{notEmpty:!0,integer:!0}};return{name:"Comment",initData:{likeCount:0},methodConfig:{create:{valid:VALID(e)},update:{valid:VALID(e)}}}}}),Life.JoinKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"JoinKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.NotiModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={userId:{notEmpty:!0,id:!0},targetUserId:{notEmpty:!0,id:!0},type:{notEmpty:!0,one:["comment","like-article","liek-comment","tag-article","tag-comment"]},targetId:{id:!0}};return{name:"Noti",isNotUsingHistory:!0,methodConfig:{create:{valid:VALID(e),role:Life.ROLE.ADMIN},update:!1,remove:!1}}}}),Life.ResetEmailKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"ResetEmailKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.ResetPasswordKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"ResetPasswordKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.SessionKeyModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";return{name:"SessionKey",methodConfig:{create:!1,update:!1,remove:!1}}}}),Life.UserModel=OBJECT({preset:function(){"use strict";return Life.MODEL},params:function(){"use strict";var e={username:{notEmpty:!0,size:{min:4,max:20},username:!0},nickname:{notEmpty:!0,size:{min:2,max:20}},email:{notEmpty:!0,size:{min:5,max:320},email:!0},password:{notEmpty:!0,size:{min:4,max:20}},loginCount:{notEmpty:!0,integer:!0},lastLoginTime:{date:!0},isBanned:{bool:!0},isLeft:{bool:!0},isAgreedTerms:{notEmpty:!0,equal:!0},isAgreedPrivacy:{notEmpty:!0,equal:!0},roles:{array:!0},iconFileId:{id:!0},lastArticleTime:{date:!0},articleCount:{notEmpty:!0,integer:!0},lastCommentTime:{date:!0},commentCount:{notEmpty:!0,integer:!0},intoduce:{size:{max:3e4}},html:!0};return{name:"User",initData:{loginCount:0,articleCount:0,commentCount:0},methodConfig:{create:{valid:VALID(e)},update:{valid:VALID(e)},remove:!1},loginValid:VALID({username:e.username,password:e.password})}}}),Life("ROLE").ADMIN="Admin",Life("ROLE").MANAGER="Manager",Life("ROLE").USER="User";Life.MAIN=METHOD({run:function(e,i){"use strict";var t=require("less");e(NSP.Bridge({rootPath:"./Life/view",restURI:["account/create","board","article","user","account/reset-password","account/verify-email"]}).requestListener),i({extension:"less",preprocessor:function(e,i){t.render(e,function(e,t){i({content:t.css,contentType:"text/css",version:CONFIG.version})})}}),UMAIL.CONNECT_TO_MAIL_SERVER({host:"smtp.gmail.com",port:465,isSecure:!0,username:NODE_CONFIG.Life.email,password:NODE_CONFIG.Life.emailPassword},function(e){Life.sendMail=e})}}),OVERRIDE(Life.ArticleLikeModel,function(e){"use strict";Life.ArticleLikeModel=OBJECT({preset:function(){return e},init:function(e,i,t){i.getDB().createIndex({articleId:1,userId:1}),e.on("create",{before:function(e,t,n,o){return NEXT([function(i){var t;void 0===o?i():void 0!==o.headers&&void 0!==o.headers.cookie&&(t=PARSE_COOKIE_STR(o.headers.cookie),void 0!==t["session-key"]&&Life.SessionKeyModel.get(t["session-key"],function(t){e.userId=t.userId,i()}))},function(){return function(){i.checkIsExists({filter:{articleId:e.articleId,userId:e.userId}},function(e){e===!0?n({validErrors:{articleId:{type:"existed"}}}):t()})}}]),!1},after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{likeCount:1}},function(i){i.writerId!==e.userId&&Life.NotiModel.create({userId:i.writerId,targetUserId:e.userId,type:"like-article",targetId:i.id})})}}),e.on("remove",{after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{likeCount:-1}})}})}})}),OVERRIDE(Life.ArticleModel,function(e){"use strict";Life.ArticleModel=OBJECT({preset:function(){return e},init:function(e,i,t){i.getDB().createIndex({boardId:1}),e.on("create",{before:function(e,i,t,n){var o;return NEXT([function(i){void 0===e.content?(e.html=void 0,i()):Life.ReplaceUserTagToLink(Markdown.MarkUp(e.content),function(t){e.html=t,i()})},function(){return function(){void 0===n?i():void 0!==n.headers&&void 0!==n.headers.cookie&&(o=PARSE_COOKIE_STR(n.headers.cookie),i())}}]),!1},after:function(e){var i,t=e.content;Life.UserModel.updateNoHistory({id:e.writerId,lastArticleTime:new Date,$inc:{articleCount:1}}),Life.BoardModel.updateNoHistory({id:e.boardId,lastArticleTime:new Date,$inc:{articleCount:1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,lastArticleTime:new Date,$inc:{articleCount:1}}),REPEAT(t.length+1,function(n){void 0===i||n!==t.length&&"@"!==t[n]&&" "!==t[n]&&"\t"!==t[n]&&"\n"!==t[n]&&"\r"!==t[n]&&"<"!==t[n]||Life.UserModel.get({filter:{nickname:t.substring(i,n)}},{notExists:function(){},success:function(i){i.id!==e.writerId&&Life.NotiModel.create({userId:i.id,targetUserId:e.writerId,type:"tag-article",targetId:e.id})}}),"@"===t[n]&&(i=n+1)})}}),e.on("update",{before:function(e,t,n,o){var r;return NEXT([function(i){e.content===TO_DELETE?(e.html=TO_DELETE,i()):void 0!==e.content?Life.ReplaceUserTagToLink(Markdown.MarkUp(e.content),function(t){e.html=t,i()}):i()},function(){return function(){void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(n){i.get(e.id,function(i){e.writerId===n.userId?t():Life.UserModel.get(n.userId,function(e){CHECK_IS_IN({array:e.roles,value:Life.ROLE.MANAGER})===!0&&t()})})}))}}]),!1},after:function(e,i){Life.BoardModel.updateNoHistory({id:e.boardId,$inc:{articleCount:1}}),Life.BoardModel.updateNoHistory({id:i.boardId,$inc:{articleCount:-1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,$inc:{articleCount:1}}),void 0!==i.categoryId&&Life.CategoryModel.updateNoHistory({id:i.categoryId,$inc:{articleCount:-1}})}}),e.on("remove",{before:function(e,t,n,o){var r;return void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(n){i.get(e,function(e){e.writerId===n.userId&&t()})})),!1},after:function(e){Life.BoardModel.updateNoHistory({id:e.boardId,$inc:{articleCount:-1}}),void 0!==e.categoryId&&Life.CategoryModel.updateNoHistory({id:e.categoryId,$inc:{articleCount:-1}})}})}})}),OVERRIDE(Life.BoardModel,function(e){"use strict";Life.BoardModel=OBJECT({preset:function(){return e},init:function(e,i,t){var n,o;e.on("create",{before:function(e,t){return void 0===e.description?e.html=void 0:e.html=Markdown.MarkUp(e.description),i.get({sort:{index:-1}},{notExists:function(){e.index=0,t()},success:function(i){e.index=i.index+1,t()}}),!1}}),e.on("update",{before:function(e,i,t,n){void 0===e.description||e.description===TO_DELETE?e.html=void 0:e.html=Markdown.MarkUp(e.description),void 0!==n&&delete e.index}}),i.moveUp=n=function(e,t){i.get(e,function(e){i.get({filter:{index:{$lt:e.index}},sort:{index:-1}},{notExists:t,success:function(n){var o=n.index;i.updateNoHistory({id:n.id,index:e.index}),i.updateNoHistory({id:e.id,index:o}),t()}})})},i.moveDown=o=function(e,t){i.get(e,function(e){i.get({filter:{index:{$gt:e.index}},sort:{index:1}},{notExists:t,success:function(n){var o=n.index;i.updateNoHistory({id:n.id,index:e.index}),i.updateNoHistory({id:e.id,index:o}),t()}})})}}})}),OVERRIDE(Life.ChatModel,function(e){"use strict";Life.ChatModel=OBJECT({preset:function(){return e},init:function(e,i,t){var n=Life.SHARED_STORE("connectionStore");n.save({id:"connectionCount",data:{count:0}}),e.on("create",{before:function(e,i,t,n){return void 0!==e.writerId&&Life.UserModel.get(e.writerId,function(t){e.writerNickname=t.nickname,e.writerIconFileId=t.iconFileId,i()}),!1}}),Life.ROOM(i.getName(),function(e,t){n.update({id:"connectionCount",data:{$inc:{count:1}}}),n.get("connectionCount",e=>{Life.BROADCAST({roomName:i.getName(),methodName:"clientConnected",data:e.count})}),t("__DISCONNECTED",function(){n.update({id:"connectionCount",data:{$inc:{count:-1}}}),n.get("connectionCount",e=>{Life.BROADCAST({roomName:i.getName(),methodName:"clientDisconnected",data:e.count})})}),t("getConnectionCount",function(e,i){n.get("connectionCount",e=>{i(e.count)})})})}})}),OVERRIDE(Life.CommentLikeModel,function(e){"use strict";Life.CommentLikeModel=OBJECT({preset:function(){return e},init:function(e,i,t){i.getDB().createIndex({commentId:1,userId:1}),e.on("create",{before:function(e,t,n,o){return NEXT([function(i){var t;void 0===o?i():void 0!==o.headers&&void 0!==o.headers.cookie&&(t=PARSE_COOKIE_STR(o.headers.cookie),void 0!==t["session-key"]&&Life.SessionKeyModel.get(t["session-key"],function(t){e.userId=t.userId,i()}))},function(){return function(){i.checkIsExists({filter:{commentId:e.commentId,userId:e.userId}},function(e){e===!0?n({validErrors:{commentId:{type:"existed"}}}):t()})}}]),!1},after:function(e){Life.CommentModel.updateNoHistory({id:e.commentId,$inc:{likeCount:1}},function(i){i.writerId!==e.userId&&Life.NotiModel.create({userId:i.writerId,targetUserId:e.userId,type:"like-comment",targetId:i.id})})}}),e.on("remove",{after:function(e){Life.CommentModel.updateNoHistory({id:e.commentId,$inc:{likeCount:-1}})}})}})}),OVERRIDE(Life.CommentModel,function(e){"use strict";Life.CommentModel=OBJECT({preset:function(){return e},init:function(e,i,t){i.getDB().createIndex({articleId:1}),e.on("create",{before:function(e,i,t,n){var o;return void 0===n?i():void 0!==n.headers&&void 0!==n.headers.cookie&&(o=PARSE_COOKIE_STR(n.headers.cookie),void 0!==o["session-key"]&&Life.SessionKeyModel.get(o["session-key"],function(t){e.writerId=t.userId,i()})),!1},after:function(e){var i,t=e.content;Life.UserModel.updateNoHistory({id:e.writerId,lastCommentTime:new Date,$inc:{commentCount:1}}),Life.ArticleModel.updateNoHistory({id:e.articleId,lastCommentTime:new Date,$inc:{commentCount:1}},function(i){i.writerId!==e.writerId&&Life.NotiModel.create({userId:i.writerId,targetUserId:e.writerId,type:"comment",targetId:e.articleId})}),REPEAT(t.length+1,function(n){void 0===i||n!==t.length&&"@"!==t[n]&&" "!==t[n]&&"\t"!==t[n]&&"\n"!==t[n]&&"\r"!==t[n]&&"<"!==t[n]||Life.UserModel.get({filter:{nickname:t.substring(i,n)}},{notExists:function(){},success:function(i){i.id!==e.writerId&&Life.NotiModel.create({userId:i.id,targetUserId:e.writerId,type:"tag-comment",targetId:e.id})}}),"@"===t[n]&&(i=n+1)})}}),e.on("update",{before:function(e,t,n,o){var r;return void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(n){i.get(e.id,function(e){e.writerId===n.userId&&t()})})),!1}}),e.on("remove",{before:function(e,t,n,o){var r;return void 0===o?t():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(n){i.get(e,function(e){e.writerId===n.userId&&t()})})),!1},after:function(e){Life.ArticleModel.updateNoHistory({id:e.articleId,$inc:{commentCount:-1}})}})}})}),OVERRIDE(Life.NotiModel,function(e){"use strict";Life.NotiModel=OBJECT({preset:function(){return e},init:function(e,i,t){i.getDB().createIndex({userId:1})}})}),OVERRIDE(Life.UserModel,function(e){"use strict";Life.UserModel=OBJECT({preset:function(){return e},init:function(e,i,t){var n;i.getDB().createIndex({nickname:1}),e.on("create",{before:function(e,t,n){return void 0===e.intoduce?e.html=void 0:e.html=Markdown.MarkUp(e.intoduce),i.checkIsExists({filter:{username:e.username}},function(o){o===!0?n({validErrors:{username:{type:"existed"}}}):i.checkIsExists({filter:{nickname:e.nickname}},function(i){i===!0?n({validErrors:{nickname:{type:"existed"}}}):(e.password=SHA256({key:e.username,password:e.password}),delete e.isBanned,delete e.isLeft,e.roles=[Life.ROLE.USER],t())})}),!1},after:function(e){delete e.password,Life.JoinKeyModel.find({filter:{email:e.email},isFindAll:!0},EACH(function(e){Life.JoinKeyModel.remove(e.id)}))}}),e.on("update",{before:function(e,t,n,o){var r;return void 0===e.intoduce||e.intoduce===TO_DELETE?e.html=void 0:e.html=Markdown.MarkUp(e.intoduce),void 0!==o&&delete e.email,delete e.isBanned,delete e.isLeft,NEXT([function(i){void 0===o?i():void 0!==o.headers&&void 0!==o.headers.cookie&&(r=PARSE_COOKIE_STR(o.headers.cookie),void 0!==r["session-key"]&&Life.SessionKeyModel.get(r["session-key"],function(t){e.id===t.userId&&i()}))},function(){return function(){i.get(e.id,function(o){NEXT([function(t){e.username===o.username?(void 0!==e.password&&(e.password=SHA256({key:o.username,password:e.password})),t()):void 0!==e.username?i.checkIsExists({filter:{username:e.username}},function(i){i===!0?n({validErrors:{username:{type:"existed"}}}):i===!1&&(void 0!==e.password&&(e.password=SHA256({key:e.username,password:e.password})),t())}):void 0!==e.password?(e.password=SHA256({key:o.username,password:e.password}),t()):t()},function(t){return function(){void 0!==e.nickname&&e.nickname!==o.nickname?i.checkIsExists({filter:{nickname:e.nickname}},function(e){e===!0?n({validErrors:{nickname:{type:"existed"}}}):t()}):t()}},function(){return function(){void 0!==e.iconFileId?IMAGEMAGICK_RESIZE({srcPath:"__RF/Life/"+e.iconFileId,distPath:"__RF/Life/ICON/"+e.iconFileId,width:40,height:40},t):t()}}])})}}]),!1},after:function(e){delete e.password}}),e.on("get",function(e){delete e.password}),e.on("find",EACH(function(e){delete e.password})),i.login=n=function(e,t){i.get({filter:{username:e.username,password:SHA256({key:e.username,password:e.password})}},{notExists:function(){t.notValid()},success:function(e){e.isLeft===!0?t.notValid():Life.SessionKeyModel.create({userId:e.id},function(n){i.updateNoHistory({id:e.id,lastLoginTime:new Date,$inc:{loginCount:1}},function(e){t.success(e,n.id)})})}})}}})});